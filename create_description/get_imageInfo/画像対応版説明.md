# Excel画像対応版スクリプト - 完全ガイド

## 概要

Excel内の画像（図表、フローチャート、状態遷移図など）を抽出し、LLM（gpt-4o）に渡して分析する機能を追加しました。

---

## 現状のスクリプトの問題点

### `pd.read_excel()`の制限

```python
# これでは画像は取得されない
df = pd.read_excel("file.xlsx")
```

`pandas`の`read_excel()`は**テキストと数値のみ**を取得します。以下は取得されません：
- 埋め込み画像（PNG, JPGなど）
- グラフ・チャート
- 図形・SmartArt
- ワードアート

---

## 解決策：画像対応版スクリプト

### 提供するスクリプト

1. **extract_info_with_images.py** - 事実抽出（画像対応版）
2. **create_summary_with_images.py** - 解説生成（画像対応版）
3. **excel_image_extraction_sample.py** - 画像抽出サンプルコード

---

## 技術的な仕組み

### 1. 画像の抽出

```python
import openpyxl
from PIL import Image
import io

def extract_images_from_sheet(excel_path: str, sheet_name: str):
    wb = openpyxl.load_workbook(excel_path)
    sheet = wb[sheet_name]
    
    images = []
    if hasattr(sheet, '_images'):
        for img in sheet._images:
            image_data = img._data()
            pil_image = Image.open(io.BytesIO(image_data))
            images.append(pil_image)
    
    return images
```

**重要**: `openpyxl`を使用してExcelファイルから画像を抽出します。

### 2. 画像のBase64エンコード

```python
import base64

def image_to_base64(image: Image.Image) -> str:
    buffered = io.BytesIO()
    # リサイズ（トークン節約）
    image.thumbnail((1024, 1024), Image.Resampling.LANCZOS)
    image.save(buffered, format="PNG")
    return base64.b64encode(buffered.getvalue()).decode()
```

### 3. LLMへの送信

```python
user_content = [
    {
        "type": "text",
        "text": "テーブルデータ..."
    },
    {
        "type": "image_url",
        "image_url": {
            "url": f"data:image/png;base64,{base64_image}"
        }
    }
]

response = client.chat.completions.create(
    model="gpt-4o",  # Vision対応モデル
    messages=[
        {"role": "system", "content": prompt},
        {"role": "user", "content": user_content}
    ]
)
```

**重要**: `gpt-4o`はVision機能を持ち、画像を理解できます。

---

## 使い方

### 必要なライブラリ

```bash
pip install openpyxl Pillow pandas azure-identity openai
```

### extract_info_with_images.py（事実抽出）

```bash
# 通常実行（画像あり）
python extract_info_with_images.py

# チャンク分割 + 画像
python extract_info_with_images.py --chunking

# 画像なし（従来版と同じ）
python extract_info_with_images.py --no-images

# チャンク分割 + 画像なし
python extract_info_with_images.py --chunking --no-images
```

### create_summary_with_images.py（解説生成）

```bash
# 通常実行（画像あり）
python create_summary_with_images.py

# チャンク分割 + 画像
python create_summary_with_images.py --chunking

# 画像なし
python create_summary_with_images.py --no-images
```

---

## 動作の違い

### 画像なし（従来版）

```
シート内容:
- テーブルデータ
- (画像は無視される)

LLMに送信:
- テーブルのMarkdown表現のみ

抽出結果:
- テーブルから読み取れる情報のみ
```

### 画像あり（新版）

```
シート内容:
- テーブルデータ
- 画像1: フローチャート
- 画像2: 状態遷移図

LLMに送信:
- テーブルのMarkdown表現
- フローチャート（Base64エンコード）
- 状態遷移図（Base64エンコード）

抽出結果:
- テーブルから読み取れる情報
- フローチャートから読み取れる処理フロー
- 状態遷移図から読み取れる状態遷移
```

---

## 画像の扱い方の詳細

### 画像数の制限

スクリプトは**最大5枚まで**の画像をLLMに送信します（トークン制限対策）。

```python
# 最大5枚まで
for img in images[:5]:
    # 処理...
```

### 画像のリサイズ

大きな画像は自動的に1024x1024にリサイズされます（トークン節約）。

```python
max_size = (1024, 1024)
image.thumbnail(max_size, Image.Resampling.LANCZOS)
```

### チャンク分割時の画像

チャンク分割を使用する場合、**最初のチャンクにのみ画像を含めます**。

```python
# 最初のチャンクにのみ画像を含める
chunk_images = images if i == 1 else []
```

**理由**: 全チャンクに画像を含めるとトークン数が膨大になり、レート制限やコスト増加の原因になります。

---

## コストとトークン数

### 画像のトークン消費

Azure OpenAIのgpt-4oでは、画像は**詳細度に応じて**トークンを消費します。

**概算**:
- 512x512の画像: 約170トークン
- 1024x1024の画像: 約765トークン

### コスト試算

画像を含めると、含めない場合と比べて**1.5倍〜3倍**のトークンを消費する可能性があります。

**例**:
- テキストのみ: 1000トークン
- テキスト + 画像3枚: 約2500トークン

---

## 注意点と制限事項

### 1. .xlsファイルの制限

`.xls`（古い形式）では画像抽出が**うまく動作しない**場合があります。

**対策**: `.xlsx`形式に変換してから処理してください。

### 2. 画像の種類

以下の画像は抽出できます：
- ✅ 埋め込み画像（PNG, JPEG）
- ✅ 図表
- ✅ スクリーンショット

以下は抽出できません：
- ❌ Excelのネイティブグラフ（チャート）
- ❌ 図形（Shape）
- ❌ SmartArt
- ❌ ワードアート

**Excelグラフの対策**: グラフを画像としてコピー＆貼り付けすれば抽出可能になります。

### 3. 処理時間とコスト

画像を含めると：
- 処理時間が長くなる
- トークン消費が増える
- コストが増加する

**推奨**: まずは`--no-images`で試し、画像が重要な場合のみ画像ありで実行。

---

## トラブルシューティング

### Q: "Could not extract images"という警告が出る

**A**: 
- シートに画像が存在しない（正常）
- `.xls`ファイルを使用している → `.xlsx`に変換
- 画像ではなく図形やグラフである → 画像として貼り付け直す

### Q: レート制限エラーが出る

**A**: 画像を含めるとトークン数が増えるため、レート制限にかかりやすくなります。

**対策**:
1. `--chunking`オプションを使用
2. 待機時間を増やす（`WAIT_TIME_BETWEEN_SHEETS`を3〜5秒に）
3. チャンクサイズを小さくする（`MAX_ROWS_PER_CHUNK = 50`）
4. `--no-images`で画像なしで実行

### Q: 画像の内容が正しく認識されない

**A**: 
- 画像が不鮮明 → より高解像度の画像に差し替え
- 画像が小さすぎる → 拡大してから貼り付け
- 画像の内容が複雑すぎる → シンプルな図に変更

### Q: コストが予想以上に高い

**A**: 画像は多くのトークンを消費します。

**対策**:
- 重要なファイルのみ画像ありで処理
- 画像数を減らす（シート内の画像を厳選）
- 画像のサイズを小さくしてからExcelに貼り付け

---

## 実用例

### 例1: フローチャートを含む仕様書

```
シート1: 概要（テキストのみ）
シート2: 処理フロー（フローチャート画像あり）
シート3: パラメータ表（テキストのみ）
```

**実行**:
```bash
python extract_info_with_images.py
```

**結果**:
- シート1: テキストから事実抽出
- シート2: **フローチャートから処理フローを抽出** ← 重要！
- シート3: テキストから事実抽出

### 例2: 状態遷移図を含む仕様書

```
シート: 状態遷移（状態遷移図画像 + 説明テキスト）
```

**実行**:
```bash
python create_summary_with_images.py
```

**結果**:
- 状態遷移図から状態とトランジションを理解
- テキストと画像を統合した包括的な解説

---

## パフォーマンス比較

| 項目 | 画像なし | 画像あり |
|-----|---------|---------|
| 処理速度 | 速い | 遅い |
| トークン消費 | 少ない | 多い（1.5〜3倍） |
| コスト | 低い | 高い |
| 情報量 | テキストのみ | テキスト + 図表 |
| 精度 | 中 | 高（図表を理解） |

---

## 推奨される使い分け

### 画像なしで十分な場合
- テキストと数値のみの仕様書
- 画像が装飾的なもの（重要でない）
- コストを抑えたい
- 処理速度を優先

### 画像ありが推奨される場合
- フローチャートや状態遷移図が含まれる
- 図表が重要な情報を含む
- テキストだけでは理解が難しい
- 精度を最優先

### 推奨ワークフロー

```
ステップ1: 画像なしで全ファイルを処理
  → 大まかな内容を把握

ステップ2: 重要なファイルを特定

ステップ3: 重要なファイルのみ画像ありで再処理
  → .mdファイルを削除してから実行
```

---

## まとめ

### 画像対応の主なメリット
✅ フローチャート、状態遷移図などを理解できる
✅ より包括的な情報抽出が可能
✅ 図表とテキストを統合した解説

### 主なデメリット
❌ トークン消費が増加（1.5〜3倍）
❌ 処理時間が長くなる
❌ コストが上昇

### 推奨アプローチ
1. まず画像なしで全体を処理
2. 図表が重要なファイルを特定
3. それらのファイルのみ画像ありで再処理

これにより、コストを抑えつつ、重要な図表情報を取得できます。
