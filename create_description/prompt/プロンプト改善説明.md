# プロンプト改善案 - 詳細説明

## 提供する4つのバージョン

### V1: 基本的な改善版（推奨）
**特徴**:
- 追加要件（内部/外部の区別）を反映
- 構造を明確化
- 記述ルールを5つに整理

**こんな人におすすめ**:
- シンプルで分かりやすいプロンプトが欲しい
- まずは基本的な改善から試したい

---

### V2: 詳細指示版 + Few-shot例（最推奨）
**特徴**:
- 各項目の具体例を提示
- チェックリストで品質保証
- 表形式の使用を推奨
- 出力例を含む

**こんな人におすすめ**:
- 最高品質の出力が欲しい
- LLMに具体的な指示を出したい
- 一貫性のある出力を求める

**メリット**:
✅ 出力の品質が最も安定
✅ 内部/外部の区別が明確
✅ フォーマットが統一される

---

### V3: システム/ユーザープロンプト分離版
**特徴**:
- システムプロンプトで原則を定義
- ユーザープロンプトでタスクを指示
- 役割分担が明確

**こんな人におすすめ**:
- システムプロンプトを活用したい
- 繰り返し使う原則を分離したい
- API設計に詳しい

**使い方**:
```python
response = client.chat.completions.create(
    model=DEPLOYMENT_NAME,
    messages=[
        {"role": "system", "content": SYSTEM_PROMPT_V3},
        {"role": "user", "content": USER_PROMPT_V3.format(
            basename=basename,
            markdown_text=markdown_text
        )}
    ]
)
```

---

### V4: 厳密構造指定版
**特徴**:
- 出力フォーマットを完全に固定
- セクション番号まで指定
- 表形式を強制

**こんな人におすすめ**:
- 完全に統一されたフォーマットが必要
- 自動処理で解析する予定
- 厳密な構造が求められる

**デメリット**:
⚠️ 柔軟性が低い
⚠️ LLMが構造に縛られすぎる可能性

---

## 主な改善点

### 1. 内部/外部の明確な区別

#### 従来
```
## 制約・エラー処理
- パラメータ制約
- タイミング制約
- エラー処理
```

#### 改善後
```
## 4. 制約・エラー処理
### 4.1 内部制約（当該機能内）
- パラメータ制約
- タイミング制約
- リソース制約

### 4.2 外部制約（他機能から課される）
- 呼び出し制約
- 排他制御
- 依存順序

### 4.3 エラー処理
```

**効果**: 制約の由来が明確になり、保守性が向上

---

### 2. 依存関係の詳細化

#### 従来
```
## 依存関係・前提条件
- 依存する機能
- 前提条件
```

#### 改善後
```
## 5. 依存関係・前提条件
### 5.1 内部依存（当該機能内）
- 処理順序依存
- データ依存
- 状態依存

### 5.2 外部依存（他機能との関係）
- 必須機能
- 連携機能
- 影響先機能

### 5.3 前提条件
- ハードウェア前提
- ソフトウェア前提
- システム状態前提
```

**効果**: 依存関係の種類が明確になり、影響範囲を把握しやすい

---

### 3. 具体例の提示（V2のみ）

#### プロンプト内での例示
```
**入力**:
- パラメータ名、型、有効範囲、デフォルト値
- 例: `exposure_time (float, 0.1-10.0秒, デフォルト1.0)`
```

**効果**: LLMが期待される出力形式を理解しやすい

---

### 4. チェックリスト追加（V2のみ）

```
## 最終チェックリスト
回答前に以下を確認してください：
□ 全ての項目に記載があるか（「記載なし」含む）
□ 推測・補完していないか
□ 内部/外部の区別が明確か
□ 矛盾がある場合、両論併記しているか
□ 具体的な値・条件を記載しているか
```

**効果**: 出力の品質チェックをLLM自身に促す

---

### 5. 出典明記の強化

#### 従来
```
- 出典（セクション名/見出し）を付与すること
```

#### 改善後（V2）
```
### 記述ルール
📝 **追跡可能**: 重要な記述には出典（セクション名）を付記

### 出力例
- `exposure_time`: 0.1秒以上10.0秒以下（出典: パラメータ仕様）
```

**効果**: 出典の記載方法が明確になる

---

## バージョン比較表

| 項目 | V1 | V2 | V3 | V4 |
|------|----|----|----|----|
| シンプルさ | ⭐⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐ |
| 出力品質 | ⭐⭐ | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ |
| 柔軟性 | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ | ⭐ |
| 一貫性 | ⭐⭐ | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ |
| 学習しやすさ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ | ⭐⭐ |
| 実装難易度 | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ |

---

## 推奨事項

### ステップ1: V2から試す
```python
PROMPT = PROMPT_V2  # improved_prompts.pyから
```

**理由**:
- 具体例があるので出力品質が高い
- チェックリストで品質保証
- 実装が簡単（そのまま使える）

### ステップ2: 出力を評価

出力された解説を確認：
- ✅ 内部/外部の区別が明確か？
- ✅ 出典が適切に記載されているか？
- ✅ 「記載なし」が適切に使われているか？
- ✅ 推測や補完がないか？

### ステップ3: 必要に応じて調整

満足できない場合：
- 構造をもっと厳密にしたい → V4を試す
- システムプロンプトを分離したい → V3を試す
- もっとシンプルにしたい → V1を試す

---

## 実装例（V2使用）

```python
from improved_prompts import PROMPT_V2

def integrate_facts_to_document(basename: str, markdown_text: str, 
                                client: AzureOpenAI) -> str:
    """
    抽出された事実から解説ドキュメントを生成
    
    Args:
        basename: 機能名
        markdown_text: 抽出された事実（Markdown形式）
        client: AzureOpenAIクライアント
    
    Returns:
        統合された解説ドキュメント（Markdown形式）
    """
    response = client.chat.completions.create(
        model=DEPLOYMENT_NAME,
        messages=[
            {"role": "system", "content": "あなたは技術文書作成の専門家です。"},
            {"role": "user", "content": PROMPT_V2.format(
                basename=basename,
                markdown_text=markdown_text
            )}
        ],
        max_tokens=16000,
        temperature=0.3  # 一貫性を高めるため低めに設定
    )
    
    return response.choices[0].message.content
```

---

## さらなる改善のヒント

### 1. Temperature調整

```python
temperature=0.3  # 一貫性重視（推奨）
temperature=0.7  # 創造性とのバランス
temperature=0.0  # 最も決定論的（再現性最高）
```

### 2. Few-shotの追加

プロンプトに良い例と悪い例を追加：

```
## 良い例
【入力】
- [処理内容] 関数Xは入力Aを処理する

【出力】
### 2.1 入力
| パラメータ | 型 | 説明 | 出典 |
|-----------|---|------|------|
| A | int | 入力データ | 関数仕様 |

## 悪い例
【入力】
- [処理内容] 関数Xは入力Aを処理する

【出力】
関数Xは一般的な処理を行います。← 推測を含むNG
```

### 3. 段階的プロンプティング

複雑な場合は2段階に分ける：

**段階1**: 情報を整理
```
事実を以下に分類してください：
1. インターフェース関連
2. 処理フロー関連
3. 制約関連
...
```

**段階2**: ドキュメント生成
```
整理された情報から解説を作成してください...
```

---

## トラブルシューティング

### Q: 「記載なし」が多すぎる

**A**: 抽出段階でより多くの情報を取得する必要があります。
- `extract_info`のプロンプトを改善
- max_tokensを増やす
- チャンク分割を見直す

### Q: 内部/外部の区別が曖昧

**A**: プロンプトに明示的な判断基準を追加：
```
【判断基準】
- 内部: 当該機能のコード内で定義・チェックされる制約
- 外部: 他機能から要求される制約、システム全体の制約
```

### Q: 出典が適切に記載されない

**A**: プロンプトで出典の重要性を強調：
```
⚠️ 重要: 全ての事実には必ず出典を付けてください。
出典がない記述は信頼性が低下します。
```

---

## まとめ

### 推奨アプローチ

1. **まずV2を試す**（最もバランスが良い）
2. 出力を評価し、必要に応じて調整
3. Temperature=0.3で一貫性を確保
4. 段階的プロンプティングも検討

### 期待される改善効果

✅ 内部/外部制約が明確に区別される
✅ 依存関係の種類が整理される
✅ 出典が適切に記載される
✅ 「記載なし」が適切に使われる
✅ 推測・補完が排除される
✅ ドキュメントの保守性が向上

**最重要**: プロンプトは一度で完璧にならないので、実際の出力を見ながら反復改善してください！
