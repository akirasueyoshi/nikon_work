# 解説生成スクリプト - チャンク対応版

## 修正内容

両方のスクリプト（v2とv3）に**大きなシート対応のチャンク分割機能**を追加しました。

### 追加された機能

1. **自動チャンク分割**: 大きなシート（デフォルト100行以上）を自動的に分割
2. **チャンク単位処理**: 各チャンクを個別に処理してレート制限を回避
3. **結果の統合**: チャンク処理結果を自動的に統合
4. **オプション制御**: `--chunking`オプションで機能を有効化

---

## 使い方

### v2（2段階方式）

```bash
# 通常実行（チャンク分割なし）
python create_summary_v2_chunking.py

# チャンク分割を有効化
python create_summary_v2_chunking.py --chunking
```

### v3（詳細解説方式）

```bash
# 通常実行（チャンク分割なし）
python create_summary_v3_detailed_chunking.py

# チャンク分割を有効化
python create_summary_v3_detailed_chunking.py --chunking
```

---

## チャンク分割の動作

### 100行以下のシートの場合
```
シート全体を一度に処理
```

### 100行超のシートの場合（--chunkingオプション使用時）
```
シート（300行）
├─ チャンク1（行1-100）  → 概要A
├─ チャンク2（行101-200） → 概要B
└─ チャンク3（行201-300） → 概要C

結果: 概要A + 概要B + 概要C → 統合概要
```

---

## いつチャンク分割を使うべきか

### ✅ チャンク分割を使う場合
- シートの行数が100行を超える
- レート制限エラーが発生する
- 「Rate limit exceeded」というエラーが出る
- トークン数制限に引っかかる

### ❌ チャンク分割不要な場合
- 全シートが小さい（各シート100行以下）
- レート制限エラーが出ていない
- 処理時間を短縮したい

---

## カスタマイズ

### チャンクサイズの変更

レート制限が厳しい場合は、チャンクサイズを小さくできます：

```python
# スクリプトの冒頭で変更
MAX_ROWS_PER_CHUNK = 50  # 100行 → 50行に変更
```

### 待機時間の調整

```python
WAIT_TIME_BETWEEN_SHEETS = 3  # シート/チャンク間（デフォルト: 2秒）
WAIT_TIME_BETWEEN_FILES = 10  # ファイル間（デフォルト: 5秒）
```

---

## 処理フローの比較

### v2（2段階方式）+ チャンク分割

```
ファイル
├─ シート1（250行）
│  ├─ チャンク1 → 概要A1
│  ├─ チャンク2 → 概要A2
│  └─ チャンク3 → 概要A3
│  結果: A1+A2+A3 → シート1概要
│
├─ シート2（80行）
│  └─ 全体処理 → シート2概要
│
└─ 統合処理
   シート1概要 + シート2概要 → 最終解説
```

### v3（詳細解説方式）+ チャンク分割

```
ファイル
├─ シート1（250行）
│  ├─ チャンク1 → 詳細解説A1
│  ├─ チャンク2 → 詳細解説A2
│  └─ チャンク3 → 詳細解説A3
│  結果: A1+A2+A3 → シート1詳細解説
│
├─ シート2（80行）
│  └─ 全体処理 → シート2詳細解説
│
└─ 統合処理
   統合解説 + シート1詳細 + シート2詳細
```

---

## 推奨される運用方法

### ステップ1: まずは通常モードで試す

```bash
# チャンク分割なしで実行
python create_summary_v2_chunking.py
```

### ステップ2: レート制限エラーが出た場合

```bash
# エラーが出たファイルの.mdを削除
rm summary/エラーファイル.md

# チャンク分割を有効にして再実行
python create_summary_v2_chunking.py --chunking
```

既に処理済みのファイルは自動的にスキップされるため、エラーが出たファイルだけがチャンク分割で再処理されます。

---

## トラブルシューティング

### Q: チャンク分割してもレート制限エラーが出る

**A**: 以下を試してください：
1. チャンクサイズを小さくする（`MAX_ROWS_PER_CHUNK = 50`）
2. 待機時間を長くする（`WAIT_TIME_BETWEEN_SHEETS = 5`）
3. 一度に処理するファイル数を減らす

### Q: チャンク分割すると処理時間が長くなる

**A**: 正常な動作です。レート制限を回避するためにチャンク間で待機時間を入れているためです。処理時間よりもエラー回避を優先する場合に使用してください。

### Q: チャンク分割の有無で出力内容が変わる？

**A**: はい、多少変わる可能性があります：
- **チャンクなし**: シート全体を一度に見て概要/解説を作成
- **チャンクあり**: 部分的に見た概要/解説を統合

重要な情報は両方で抽出されますが、表現が若干異なる場合があります。

---

## パフォーマンス比較

| モード | 処理速度 | レート制限への強さ | 出力品質 |
|--------|---------|------------------|---------|
| v2（通常） | 速い | 中 | 概要レベル |
| v2 + チャンク | 中 | 強い | 概要レベル |
| v3（通常） | 遅い | 弱い | 詳細レベル |
| v3 + チャンク | 非常に遅い | 非常に強い | 詳細レベル |

---

## まとめ

- **基本的にはチャンクなしで実行**を推奨
- **レート制限エラーが出た場合のみ`--chunking`を使用**
- エラーファイルの`.md`を削除してから`--chunking`で再実行
- チャンクサイズと待機時間は必要に応じて調整可能
